#!/usr/bin/env python3

from pathlib import Path
from subprocess import run, PIPE
import sys

HOME = Path.home().resolve()

# Allows e.g. searching for modified git repos in an old backup of someone's
# home directory.
if len(sys.argv) > 1 and sys.argv[1] == '--cwd':
    HOME = Path.cwd()

ignored_dirs = [
    # ~/.local/share/**/.git
    *HOME.glob('.local/share/**/.git'),

    # ~/.cache/**/.git/
    *(HOME / '.cache').glob('**/.git'),

    # ~/.cargo/**/.git/
    *(HOME / '.cargo').glob('**/.git'),

    # ~/**/.cargo/git/checkouts/*/.git/
    *HOME.glob('**/.cargo/git/checkouts/**/.git'),
]

for git_dir in Path.cwd().glob('**/.git'):
    if git_dir in ignored_dirs:
        continue

    repo = git_dir.parent
    status = run(['git', 'status', '-s'], cwd=repo, check=False, stdout=PIPE, stderr=PIPE)
    if status.stdout or status.stderr or status.returncode != 0:
        print(str(repo))
