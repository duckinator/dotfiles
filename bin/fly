#!/usr/bin/env python3

import os
import stat
import sys
from urllib.request import urlopen as get

version = "v4.2.2"
filename = "fly_linux_amd64-{}".format(version)

file_path = os.path.join(os.environ["HOME"], "software", filename)

def ensure_parent_directory_exists(file_path):
    directory = os.path.dirname(file_path)
    os.makedirs(directory, exist_ok=True)

def make_executable(file_path):
    st = os.stat(file_path)
    os.chmod(file_path, st.st_mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)

def download_file(url, file_path):
    data = get(url).read()
    with open(file_path, "wb") as f:
        f.write(data)

def download_executable(url, file_path):
    ensure_parent_directory_exists(file_path)
    download_file(url, file_path)

# Download the executable if required.
if not os.path.isfile(file_path):
    url = "https://github.com/concourse/concourse/releases/download/{}/fly_linux_amd64".format(version)
    download_executable(url, file_path)


make_executable(file_path)

# Run the executable.
os.execvp(file_path, sys.argv)
